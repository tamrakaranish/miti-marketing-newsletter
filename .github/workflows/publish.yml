name: Publish Newsletter

on:
  push:
    branches: [ main ]
    paths:
      - "newsletter/*.md"

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find latest newsletter file
        id: find
        shell: bash
        run: |
          set -euo pipefail
          FILE="$(ls -1t newsletter/*.md | head -n 1)"
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Post preview to Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: "#ai-newsletter"   # <-- change to your channel
          FILE: ${{ steps.find.outputs.file }}
        shell: bash
        run: |
          set -euo pipefail
          PREVIEW="$(head -n 20 "$FILE")"
          JSON="$(jq -n --arg ch "$SLACK_CHANNEL" --arg txt "$PREVIEW" \
            '{channel:$ch, text:("New issue published:\n" + $txt), unfurl_links:false}')"
          curl -s -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "$JSON" | jq .

      - name: Update Confluence archive
        env:
          CF_BASE:  ${{ secrets.CONFLUENCE_BASE_URL }}      # e.g. https://yourcompany.atlassian.net
          CF_USER:  ${{ secrets.CONFLUENCE_USER }}           # Atlassian email
          CF_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}      # API token
          CF_PAGE_ID: ${{ secrets.CONFLUENCE_PAGE_ID }}      # page id for the archive
          FILE: ${{ steps.find.outputs.file }}
        shell: bash
        run: |
          set -euo pipefail
          # HTML-escape markdown content and wrap in <pre> for simplicity
          HTML_CONTENT="$(printf '<pre>%s</pre>' "$(sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' "$FILE")")"

          # Get current page version
          CURR="$(curl -s -u "$CF_USER:$CF_TOKEN" "$CF_BASE/wiki/api/v2/pages/$CF_PAGE_ID")"
          VER="$(echo "$CURR" | jq -r '.version.number // 1')"
          NEW=$((VER+1))

          TITLE="$(basename "$FILE" .md): MitiMind"

          DATA="$(jq -n --arg title "$TITLE" --arg body "$HTML_CONTENT" --argjson ver "$NEW" \
            '{version:{number:$ver}, title:$title, body:{storage:{value:$body, representation:"storage"}}}')"

          curl -s -u "$CF_USER:$CF_TOKEN" -X PUT "$CF_BASE/wiki/api/v2/pages/$CF_PAGE_ID" \
            -H "Content-Type: application/json" \
            --data "$DATA" | jq -r '.id // "ok"'
